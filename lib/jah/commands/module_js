/*globals module exports resource require window Module __main_module_name__ */
/*jslint undef: true, strict: true, white: true, newcap: true, browser: true, indent: 4 */
"use strict";

window.resource = function (path) {
    // Check for packed resource
    var r = __resources__[path];
    if (r) {
        return r.data;
    }

    // Check for remote resource
    r = __remote_resources__[path];
    if (r) {

        // Load remote image
        if (r.meta.mimetype.split('/')[0] == 'image') {
            return new (require('remote_resources').RemoteImage)(r.data, path);
        } else if (r.meta.mimetype.split('/')[1] == 'javascript') {
            return new (require('remote_resources').RemoteScript)(r.data, path);
        } else {
            return new (require('remote_resources').RemoteResource)(r.data, path);
        }
    }

    throw("Unable to find resource: " + path.toString());
};

(function () {
    var process = {};
    var modulePaths = $modulePaths$;
    var remoteLibPaths = $remoteLibPaths$;
    var globalsPaths = $globalsPaths$;

    var path; // Will be loaded further down

    function resolveModulePath(request, parent) {
        // If not a relative path then search the modulePaths for it
        var start = request.substring(0, 2);
        if (start !== "./" && start !== "..") {
            return modulePaths;
        }

        var parentIsIndex = path.basename(parent.filename).match(/^index\.js$/),
            parentPath    = parentIsIndex ? parent.id : path.dirname(parent.id);

        // Relative path so searching inside parent's directory
        return [path.dirname(parent.filename)];
    }

    function findModulePath(id, dirs) {
        if (id.charAt(0) === '/') {
            dirs = [''];
        }
        for (var i = 0; i < dirs.length; i++) {
            var dir = dirs[i];
            var p = path.join(dir, id);

            // Check for index first
            if (path.exists(path.join(p, 'index.js'))) {
                return path.join(p, 'index.js');
            } else if (path.exists(p + '.js')) {
                return p + '.js';
            }
        }

        return false;
    }

    function loadModule(request, parent) {
        parent = parent || process.mainModule;

        var paths    = resolveModulePath(request, parent),
            filename = findModulePath(request, paths);

        if (filename === false) {
            throw new Error("Unable to find module: " + request);
        }


        if (parent) {
            var cachedModule = parent.moduleCache[filename];
            if (cachedModule) {
                return cachedModule;
            }
        }

        //console.log('Loading module: ', filename);

        var module = new Module(filename, parent);

        // Assign main module to process
        if (request == __main_module_name__ && !process.mainModule) {
            process.mainModule = module;
        }

        // Run all the code in the module
        module._initialize(filename);

        return module;
    }

    function Module(id, parent) {
        this.id = id;
        this.parent = parent;
        this.children = [];
        this.exports = {};

        if (parent) {
            this.moduleCache = parent.moduleCache;
            parent.children.push(this);
        } else {
            this.moduleCache = {};
        }
        this.moduleCache[this.id] = this;

        this.filename = null;
        this.dirname = null;
    }

    Module.prototype._initialize = function (filename) {
        var module = this;
        function require(request) {
            return loadModule(request, module).exports;
        }

        this.filename = filename;

        // Work around incase this IS the path module
        if (path) {
            this.dirname = path.dirname(filename);
        } else {
            this.dirname = '';
        }

        require.paths = modulePaths;
        require.main = process.mainModule;
        __resources__ = window.__resources__;

        __resources__[this.filename].data.apply(this.exports, [this.exports, require, this, this.filename, this.dirname]);

        return this;
    };

    // Manually load the path module because we need it to load other modules
    path = (new Module('path'))._initialize('/__builtin__/path.js').exports;

    var util = loadModule('/__builtin__/').exports;

    // Browser's DOM is ready for action
    util.ready(function () {

        /**
         * @private
         * Populates global variables found inside a module
         */
        function populateGlobals (module) {
            try { 
                var globals = loadModule(module).exports;
            } catch (e) {
                if (e.message.indexOf('Unable to find module:') !== -1) {
                    return;
                }

                throw e;
            }
            for (var x in globals) {
                if (globals.hasOwnProperty(x)) {
                    window[x] = globals[x];
                }
            }
        }

        /**
         * @private
         * Execute the initialization method for a module/library
         */
        function initilizeModule (module) {
            try {
                mod = loadModule(module);
            } catch (e) {
                if (e.message.indexOf('Unable to find module:') === -1) {
                    throw e;
                }
            }

            if (mod && mod.exports && mod.exports.main) {
                mod.exports.main();
            }
        }

        /**
         * @private
         * Execute the application's main() method
         */
        function initializeApplication () {
            process.mainModule = loadModule(__main_module_name__);

            window.require.main = process.mainModule;

            // Run application's main
            if (process.mainModule.exports.main) {
                process.mainModule.exports.main();
            }
        }

        // Add a global require. Useful in the debug console.
        window.require = function require(request, parent) {
            return loadModule(request, parent).exports;
        };
        window.require.paths = modulePaths;

        // Populate application globals
        util.each(globalsPaths, populateGlobals);
        
        // Load remote libs
        var libsToLoad = [],
            remoteLib;
        for (var x in remoteLibPaths) {
            if (remoteLibPaths.hasOwnProperty(x)) {
                remoteLib = resource(remoteLibPaths[x]);
                libsToLoad.push(remoteLib);

                require('events').addListener(remoteLib, 'load', function (lib) {
                    // Populate lib's globals
                    populateGlobals(path.join(lib.path, 'globals'));

                    // Initialise module
                    initilizeModule(path.join(lib.path, 'init'));

                    // Remove lib from list
                    var pos = libsToLoad.indexOf(lib);
                    if (pos !== -1) {
                        libsToLoad.splice(pos, 1);
                    }

                    // All libs loaded, start application
                    if (libsToLoad.length == 0) {
                        initializeApplication();
                    }

                }.bind(this));

                remoteLib.load();
            }
        }
    });
})();

// vim:ft=javascript
